name: Aikya Autopilot Build & Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          npm install -g eas-cli firebase-tools

      - name: Configure Expo token
        run: echo "EXPO_TOKEN=${{ secrets.EXPO_TOKEN }}" >> $GITHUB_ENV

      - name: Start Expo Cloud Build (Android)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build --platform android --non-interactive --profile production --wait --json > /tmp/eas_build.json
          cat /tmp/eas_build.json
          jq -r '.id' /tmp/eas_build.json > /tmp/eas_build_id.txt

      - name: Download AAB artifact
        run: |
          BUILD_ID=$(cat /tmp/eas_build_id.txt)
          eas build:download --platform android --id "$BUILD_ID" --output ./app-release.aab
          ls -lh ./app-release.aab

      - name: Setup Ruby & Fastlane
        run: |
          sudo apt-get install -y ruby-full build-essential
          gem install fastlane -NV

      - name: Decode Play Store JSON key
        run: |
          echo "${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}" > /tmp/play_key.json
          chmod 600 /tmp/play_key.json

      - name: Deploy to Google Play (Internal Track)
        env:
          ANDROID_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME }}
        run: |
          fastlane supply \
            --aab ./app-release.aab \
            --track internal \
            --json_key /tmp/play_key.json \
            --package_name "$ANDROID_PACKAGE_NAME" \
            --skip_upload_metadata true \
            --skip_upload_changelogs true \
            --skip_upload_images true \
            --skip_upload_screenshots true

      - name: Deploy to Firebase Hosting
        run: |
          echo '${{ secrets.FIREBASE_PRIVATE_KEY }}' > /tmp/firebase-key.json
          firebase use --add aikya-spritual
          firebase deploy --non-interactive --only hosting --token "$(cat /tmp/firebase-key.json | jq -r .private_key_id)"
